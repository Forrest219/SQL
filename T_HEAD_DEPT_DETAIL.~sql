WITH TEMP_SIGN_BASE AS
 (SELECT FY_YEAR,
         PERIOD_MONTH,
         TRUNC(BOOKED_DATE, 'mm') AS CALENDAR_DATE,
         DEPT_CODE_LEVEL1,
         DEPT_NAME_LEVEL1,
         M_DEPT_CODE_LEVEL2,
         M_DEPT_NAME_LEVEL2,
         DEPT_OWN,
         OU_GROUP_CODE,
         OU_GROUP,
         T2.ORDER_TYPE_NAME,
         T2.NEW_CONTRACT_NAME,
         CONTRACT_AMOUNT * EXCHANGE_RATE AS CONTRACT_AMOUNT
    FROM T_SIGN_BASE@LINKBIDW T1
    LEFT JOIN (SELECT DISTINCT ORDER_TYPE_NAME, NEW_CONTRACT_NAME
                FROM T_MAP_CONTRACT_TYPE) T2
      ON T1.ORDER_TYPE_NAME = T2.ORDER_TYPE_NAME
   WHERE OU_GROUP_CODE = '101'
     AND DEPT_OWN = '本部'
     AND T1.ORDER_TYPE_NAME <> '提前执行'
     AND FY_YEAR IN (2016, 2017)),

TEMP_DEPT_SIGN AS
 (
  --一级部门签约
  SELECT FY_YEAR,
          PERIOD_MONTH,
          CALENDAR_DATE,
          DEPT_CODE_LEVEL1 AS DEPT_NUM,
          DEPT_NAME_LEVEL1 AS DEPT_NAME,
          '1' AS DEPT_LEVEL,
          DEPT_OWN,
          OU_GROUP_CODE,
          OU_GROUP,
          NEW_CONTRACT_NAME,
          'CONTRACT_AMOUNT' AS METRIC_EN,
          SUM(CONTRACT_AMOUNT) AS METRIC_VALUE
    FROM TEMP_SIGN_BASE
   GROUP BY FY_YEAR,
             PERIOD_MONTH,
             CALENDAR_DATE,
             DEPT_CODE_LEVEL1,
             DEPT_NAME_LEVEL1,
             DEPT_OWN,
             NEW_CONTRACT_NAME,
             OU_GROUP_CODE,
             OU_GROUP
  
  UNION ALL
  -- 二级部门签约
  SELECT FY_YEAR,
         PERIOD_MONTH,
         CALENDAR_DATE,
         M_DEPT_CODE_LEVEL2 AS DEPT_NUM,
         M_DEPT_NAME_LEVEL2 AS DEPT_NAME,
         '2' AS DEPT_LEVEL,
         DEPT_OWN,
         OU_GROUP_CODE,
         OU_GROUP,
         NEW_CONTRACT_NAME,
         'CONTRACT_AMOUNT' AS METRIC_EN,
         SUM(CONTRACT_AMOUNT) AS METRIC_VALUE
    FROM TEMP_SIGN_BASE
   WHERE M_DEPT_CODE_LEVEL2 IS NOT NULL
   GROUP BY FY_YEAR,
            PERIOD_MONTH,
            CALENDAR_DATE,
            M_DEPT_CODE_LEVEL2,
            M_DEPT_NAME_LEVEL2,
            DEPT_OWN,
            NEW_CONTRACT_NAME,
            OU_GROUP_CODE,
            OU_GROUP),

TEMP_RECEIPT_BASE AS
 (SELECT FY_YEAR,
         PERIOD_MONTH,
         TRUNC(PERIOD, 'mm') AS CALENDAR_DATE,
         DEPT_CODE_LEVEL1,
         DEPT_NAME_LEVEL1,
         DEPT_CODE_LEVEL2,
         DEPT_NAME_LEVEL2,
         DEPT_OWN,
         OU_GROUP_CODE,
         OU_GROUP,
         T1.ORDER_TYPE_NAME,
         T2.NEW_CONTRACT_NAME,
         FIN_RECIEPT
    FROM T_RECEIPT_BASE@LINKBIDW T1
    LEFT JOIN (SELECT DISTINCT ORDER_TYPE_NAME, NEW_CONTRACT_NAME
                FROM T_MAP_CONTRACT_TYPE) T2
      ON T1.ORDER_TYPE_NAME = T2.ORDER_TYPE_NAME
   WHERE OU_GROUP_CODE = '101'
     AND DEPT_OWN = '本部'
     AND FY_YEAR = 2017),

TEMP_DEPT_RECEIPT AS
 (
  --一级部门收入
  SELECT FY_YEAR,
          PERIOD_MONTH,
          CALENDAR_DATE,
          DEPT_CODE_LEVEL1 AS DEPT_NUM,
          DEPT_NAME_LEVEL1 AS DEPT_NAME,
          '1' AS DEPT_LEVEL,
          DEPT_OWN,
          OU_GROUP_CODE,
          OU_GROUP,
          NEW_CONTRACT_NAME,
          'FIN_RECEIPT' AS METRIC_EN,
          SUM(FIN_RECIEPT) AS METRIC_VALUE
    FROM TEMP_RECEIPT_BASE T
   GROUP BY FY_YEAR,
             PERIOD_MONTH,
             CALENDAR_DATE,
             DEPT_CODE_LEVEL1,
             DEPT_NAME_LEVEL1,
             DEPT_OWN,
             OU_GROUP_CODE,
             OU_GROUP,
             NEW_CONTRACT_NAME
  
  UNION ALL
  -- 二级部门收入
  SELECT FY_YEAR,
         PERIOD_MONTH,
         CALENDAR_DATE,
         DEPT_CODE_LEVEL2 AS DEPT_NUM,
         DEPT_NAME_LEVEL2 AS DEPT_NAME,
         '2' AS DEPT_LEVEL,
         DEPT_OWN,
         OU_GROUP_CODE,
         OU_GROUP,
         NEW_CONTRACT_NAME,
         'FIN_RECEIPT' AS METRIC_EN,
         SUM(FIN_RECIEPT) AS METRIC_VALUE
    FROM TEMP_RECEIPT_BASE T
   GROUP BY FY_YEAR,
            PERIOD_MONTH,
            CALENDAR_DATE,
            DEPT_CODE_LEVEL2,
            DEPT_NAME_LEVEL2,
            DEPT_OWN,
            OU_GROUP_CODE,
            OU_GROUP,
            NEW_CONTRACT_NAME)
            
SELECT * FROM TEMP_DEPT_RECEIPT
UNION ALL
SELECT * FROM temp_dept_sign;

